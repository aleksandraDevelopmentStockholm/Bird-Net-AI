name: App Build

on:
  # Manual trigger only
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - production
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - android

jobs:
  build:
    name: Build App (${{ inputs.profile || 'production' }} - ${{ inputs.platform || 'all' }})
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Node & pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Setup Expo & EAS
        uses: ./.github/actions/setup-expo-eas
        with:
          expo-token: ${{ secrets.EXPO_TOKEN }}

      - name: Determine build configuration
        id: config
        run: |
          PROFILE="${{ inputs.profile }}"
          PLATFORM="${{ inputs.platform }}"

          # Default to preview if not set
          PROFILE="${PROFILE:-preview}"
          PLATFORM="${PLATFORM:-all}"

          # Determine which secrets to use based on profile
          if [ "$PROFILE" = "production" ]; then
            echo "api-url-secret=BIRDNET_API_URL" >> $GITHUB_OUTPUT
            echo "api-key-secret=BIRDNET_API_KEY" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "api-url-secret=BIRDNET_API_URL_DEV" >> $GITHUB_OUTPUT
            echo "api-key-secret=BIRDNET_API_KEY_DEV" >> $GITHUB_OUTPUT
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

          echo "profile=$PROFILE" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT

          echo "ðŸ“± Configuration:"
          echo "  Profile: $PROFILE"
          echo "  Platform: $PLATFORM"
          echo "  Environment: $([ '$PROFILE' = 'production' ] && echo 'production' || echo 'development')"

      - name: Build app
        env:
          EXPO_PUBLIC_BIRDNET_API_URL: ${{ secrets[steps.config.outputs.api-url-secret] }}
          EXPO_PUBLIC_BIRDNET_API_KEY: ${{ secrets[steps.config.outputs.api-key-secret] }}
          EXPO_PUBLIC_EAS_PROJECT_ID: ${{ secrets.EXPO_PUBLIC_EAS_PROJECT_ID }}
        run: |
          echo "ðŸš€ Building ${{ steps.config.outputs.profile }} build for ${{ steps.config.outputs.platform }}"
          eas build \
            --profile ${{ steps.config.outputs.profile }} \
            --platform ${{ steps.config.outputs.platform }} \
            --non-interactive \
            --no-wait

      - name: Post build summary
        run: |
          echo "## ðŸš€ Build Started!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Profile:** ${{ steps.config.outputs.profile }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ steps.config.outputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.config.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** https://expo.dev/accounts/${{ github.repository_owner }}/projects/aiapp/builds" >> $GITHUB_STEP_SUMMARY
