name: E2E Test (Android - Docker)

on:
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Free up disk space
        run: |
          echo "ðŸ—‘ï¸ Freeing up disk space..."
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          df -h

      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Node & pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-android-${{ hashFiles('Dockerfile.android', 'pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-buildx-android-

      - name: Build Android APK in Docker
        run: |
          echo "ðŸ³ Building Android app in Docker container..."

          # Create .env file for build
          cat > .env << EOF
          APP_NAME=BirdNet
          APP_SLUG=aiapp
          ANDROID_PACKAGE=com.amalesa.aiApp
          IOS_BUNDLE_ID=com.amalesa.aiApp
          EXPO_PUBLIC_BIRDNET_API_URL=http://localhost:3001
          EXPO_PUBLIC_BIRDNET_API_KEY=mock-api-key
          EOF

          # Build Docker image with layer caching
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -f Dockerfile.android \
            -t birdnet-app:test \
            --load \
            .

          # Rotate cache to prevent it from growing indefinitely
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

          # Run build inside container and extract APK
          mkdir -p output
          docker run --rm \
            -v $(pwd)/output:/output \
            birdnet-app:test \
            sh -c "
              echo 'ðŸ“± Building Android APK...'
              pnpm expo prebuild --platform android --clean
              cd android
              ./gradlew assembleRelease
              cp app/build/outputs/apk/release/app-release.apk /output/app.apk
              echo 'âœ… APK built successfully'
            "

          # Verify APK was created
          if [ -f output/app.apk ]; then
            ls -lh output/app.apk
            echo "âœ… APK ready for testing"
          else
            echo "âŒ APK build failed"
            exit 1
          fi

          # Clean up Docker images to free space
          docker rmi birdnet-app:test || true
          docker image prune -f

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: output/app.apk
          retention-days: 7

  run-e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    needs: build-apk

    steps:
      - name: Free up disk space
        run: |
          echo "ðŸ—‘ï¸ Freeing up disk space for emulator..."
          df -h
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          df -h

      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Node & pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: output

      - name: Install mock server dependencies
        run: |
          echo "ðŸ“¦ Installing mock server dependencies..."
          cd test-server
          pnpm install --frozen-lockfile

      - name: Start mock API server
        run: |
          echo "ðŸš€ Starting mock BirdNET API server..."
          pnpm test-server &
          echo $! > server.pid
          sleep 3

      - name: Wait for server to be ready
        run: |
          echo "â³ Waiting for mock server to be ready..."
          timeout 30 bash -c 'until curl -s http://localhost:3001/health | grep -q "ok"; do sleep 1; done'
          echo "âœ… Mock server is ready!"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Android Emulator
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: android-emulator-${{ runner.os }}-api29-default-v1
          restore-keys: |
            android-emulator-${{ runner.os }}-api29-

      - name: Enable KVM for Android Emulator
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Prepare Android AVD directory
        run: |
          echo "ðŸ“ Creating Android AVD directory..."
          mkdir -p ~/.android/avd
          mkdir -p ~/.android/adb

          # Pre-create the AVD directory to avoid creation issues
          echo "ðŸ“± Pre-creating test AVD directory..."
          mkdir -p ~/.android/avd/test.avd

          ls -la ~/.android

      - name: Run E2E tests
        uses: reactivecircus/android-emulator-runner@v2.31.0
        env:
          EXPO_PUBLIC_BIRDNET_API_URL: http://10.0.2.2:3001
          EXPO_PUBLIC_BIRDNET_API_KEY: mock-api-key
        with:
          api-level: 29
          target: default
          arch: x86_64
          disable-animations: true
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          script: |
            set -e  # Exit on error

            echo "ðŸ“Š Checking disk space before tests..."
            df -h

            echo "ðŸ“¥ Installing Maestro..."
            curl -fsSL "https://get.maestro.mobile.dev" | bash
            export PATH="$PATH":"$HOME/.maestro/bin"
            maestro --version

            echo "ðŸ“± Installing APK on emulator..."
            adb install output/app.apk
            echo "âœ… App installed successfully"

            echo "ðŸŽ¨ Disabling animations..."
            adb shell settings put global window_animation_scale 0
            adb shell settings put global transition_animation_scale 0
            adb shell settings put global animator_duration_scale 0

            echo "ðŸ§ª Running E2E tests..."
            pnpm test:e2e:ci

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-android
          path: |
            ~/.maestro/tests/**/*
            maestro-report.xml
          retention-days: 7

      - name: Stop mock server
        if: always()
        run: |
          if [ -f server.pid ]; then
            echo "ðŸ›‘ Stopping mock server..."
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: Post test summary
        if: always()
        run: |
          echo "## ðŸ§ª E2E Test Results (Android - Docker)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** Android" >> $GITHUB_STEP_SUMMARY
          echo "**Build Method:** Docker (no EAS)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f maestro-report.xml ]; then
            echo "**Status:** âœ… Tests completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Tests failed or did not complete" >> $GITHUB_STEP_SUMMARY
          fi
